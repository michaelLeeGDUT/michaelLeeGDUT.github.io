/*!
 * Chirpy Theme Core JavaScript
 * Basic functionality for Chirpy Jekyll theme
 */

// Theme initialization
document.addEventListener('DOMContentLoaded', function() {
    // Initialize theme
    initTheme();
    
    // Initialize sidebar
    initSidebar();
    
    // Initialize search
    initSearch();
    
    // Initialize tooltips
    initTooltips();
    
    // Initialize copy code buttons
    initCopyCode();
});

// Theme mode switching
function initTheme() {
    const themeToggle = document.querySelector('[data-toggle="theme"]');
    if (themeToggle) {
        themeToggle.addEventListener('click', function() {
            const currentMode = document.documentElement.getAttribute('data-mode');
            const newMode = currentMode === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-mode', newMode);
            localStorage.setItem('theme-mode', newMode);
        });
    }
    
    // Load saved theme
    const savedMode = localStorage.getItem('theme-mode');
    if (savedMode) {
        document.documentElement.setAttribute('data-mode', savedMode);
    }
}

// Sidebar functionality
function initSidebar() {
    const sidebarToggle = document.querySelector('#sidebar-trigger');
    const sidebar = document.querySelector('#sidebar');
    const mask = document.querySelector('#mask');
    
    if (sidebarToggle && sidebar) {
        sidebarToggle.addEventListener('click', function() {
            sidebar.classList.toggle('unloaded');
            if (mask) {
                mask.classList.toggle('d-none');
            }
        });
    }
    
    if (mask) {
        mask.addEventListener('click', function() {
            sidebar.classList.add('unloaded');
            mask.classList.add('d-none');
        });
    }
}

// Search functionality
function initSearch() {
    const searchInput = document.querySelector('#search-input');
    const searchResults = document.querySelector('#search-results');
    
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const query = this.value.toLowerCase().trim();
            if (query.length > 2) {
                performSearch(query);
            } else if (searchResults) {
                searchResults.innerHTML = '';
            }
        });
    }
}

function performSearch(query) {
    // Basic search implementation
    const searchResults = document.querySelector('#search-results');
    if (!searchResults) return;
    
    // This is a placeholder - in a full implementation, you'd search through posts
    searchResults.innerHTML = '<p class="text-muted">Search functionality requires additional setup.</p>';
}

// Tooltip initialization
function initTooltips() {
    const tooltipElements = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    if (tooltipElements.length > 0 && typeof bootstrap !== 'undefined') {
        tooltipElements.forEach(function(element) {
            new bootstrap.Tooltip(element);
        });
    }
}

// Copy code functionality
function initCopyCode() {
    const codeBlocks = document.querySelectorAll('pre code');
    codeBlocks.forEach(function(block) {
        const button = document.createElement('button');
        button.className = 'btn btn-sm btn-outline-secondary copy-btn';
        button.innerHTML = '<i class="fas fa-copy"></i>';
        button.title = 'Copy code';
        
        button.addEventListener('click', function() {
            navigator.clipboard.writeText(block.textContent).then(function() {
                button.innerHTML = '<i class="fas fa-check"></i>';
                setTimeout(function() {
                    button.innerHTML = '<i class="fas fa-copy"></i>';
                }, 2000);
            });
        });
        
        const pre = block.parentElement;
        if (pre.tagName === 'PRE') {
            pre.style.position = 'relative';
            button.style.position = 'absolute';
            button.style.top = '10px';
            button.style.right = '10px';
            pre.appendChild(button);
        }
    });
}

// Back to top functionality
window.addEventListener('scroll', function() {
    const backToTop = document.querySelector('#back-to-top');
    if (backToTop) {
        if (window.pageYOffset > 300) {
            backToTop.style.display = 'block';
        } else {
            backToTop.style.display = 'none';
        }
    }
});

// Smooth scroll for anchor links
document.querySelectorAll('a[href^="#"]').forEach(function(anchor) {
    anchor.addEventListener('click', function(e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
            target.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }
    });
});

// Image lazy loading fallback
function initLazyLoading() {
    const images = document.querySelectorAll('img[data-src]');
    const imageObserver = new IntersectionObserver(function(entries, observer) {
        entries.forEach(function(entry) {
            if (entry.isIntersecting) {
                const img = entry.target;
                img.src = img.dataset.src;
                img.classList.remove('lazy');
                observer.unobserve(img);
            }
        });
    });
    
    images.forEach(function(img) {
        imageObserver.observe(img);
    });
}

// Initialize lazy loading if IntersectionObserver is supported
if ('IntersectionObserver' in window) {
    initLazyLoading();
}

// Export for global access
window.ChirpyTheme = {
    initTheme: initTheme,
    initSidebar: initSidebar,
    initSearch: initSearch,
    initTooltips: initTooltips,
    initCopyCode: initCopyCode
};