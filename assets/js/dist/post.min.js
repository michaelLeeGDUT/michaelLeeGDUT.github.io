/*!
 * Chirpy Theme Post Page JavaScript
 * Functionality specific to individual blog posts
 */

// Post page initialization
document.addEventListener('DOMContentLoaded', function() {
    initPostPage();
});

function initPostPage() {
    // Initialize table of contents
    initTOC();
    
    // Initialize image popup
    initImagePopup();
    
    // Initialize code copy buttons
    initCodeCopy();
    
    // Initialize share buttons
    initShareButtons();
    
    // Initialize post navigation
    initPostNavigation();
    
    // Initialize reading time
    initReadingTime();
    
    // Initialize scroll progress
    initScrollProgress();
}

// Table of Contents functionality
function initTOC() {
    const toc = document.querySelector('.toc');
    const headings = document.querySelectorAll('h2, h3, h4, h5, h6');
    
    if (!toc || headings.length === 0) return;
    
    // Generate TOC if it doesn't exist
    if (toc.children.length === 0) {
        const tocList = document.createElement('ul');
        tocList.className = 'toc-list';
        
        headings.forEach(function(heading, index) {
            if (!heading.id) {
                heading.id = 'heading-' + index;
            }
            
            const listItem = document.createElement('li');
            const link = document.createElement('a');
            link.href = '#' + heading.id;
            link.textContent = heading.textContent;
            link.className = 'toc-link';
            
            listItem.appendChild(link);
            tocList.appendChild(listItem);
        });
        
        toc.appendChild(tocList);
    }
    
    // Highlight current section
    function highlightCurrentSection() {
        let current = '';
        headings.forEach(function(heading) {
            const rect = heading.getBoundingClientRect();
            if (rect.top <= 100) {
                current = heading.id;
            }
        });
        
        document.querySelectorAll('.toc-link').forEach(function(link) {
            link.classList.remove('active');
            if (link.getAttribute('href') === '#' + current) {
                link.classList.add('active');
            }
        });
    }
    
    window.addEventListener('scroll', highlightCurrentSection);
}

// Image popup functionality
function initImagePopup() {
    const images = document.querySelectorAll('.post-content img');
    
    images.forEach(function(img) {
        img.addEventListener('click', function() {
            const overlay = document.createElement('div');
            overlay.className = 'image-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 9999;
                cursor: pointer;
            `;
            
            const enlargedImg = document.createElement('img');
            enlargedImg.src = this.src;
            enlargedImg.style.cssText = `
                max-width: 90%;
                max-height: 90%;
                object-fit: contain;
            `;
            
            overlay.appendChild(enlargedImg);
            document.body.appendChild(overlay);
            
            overlay.addEventListener('click', function() {
                document.body.removeChild(overlay);
            });
        });
        
        img.style.cursor = 'pointer';
    });
}

// Code copy functionality
function initCodeCopy() {
    const codeBlocks = document.querySelectorAll('pre code');
    
    codeBlocks.forEach(function(block) {
        const pre = block.parentElement;
        if (pre.querySelector('.copy-code-btn')) return; // Already has button
        
        const button = document.createElement('button');
        button.className = 'copy-code-btn btn btn-sm';
        button.innerHTML = '<i class="fas fa-copy"></i>';
        button.title = 'Copy code';
        button.style.cssText = `
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
        `;
        
        button.addEventListener('click', function() {
            navigator.clipboard.writeText(block.textContent).then(function() {
                button.innerHTML = '<i class="fas fa-check"></i>';
                button.style.background = 'rgba(0, 255, 0, 0.8)';
                
                setTimeout(function() {
                    button.innerHTML = '<i class="fas fa-copy"></i>';
                    button.style.background = 'rgba(255, 255, 255, 0.8)';
                }, 2000);
            });
        });
        
        pre.style.position = 'relative';
        pre.appendChild(button);
    });
}

// Share buttons functionality
function initShareButtons() {
    const shareButtons = document.querySelectorAll('.share-btn');
    
    shareButtons.forEach(function(button) {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            
            const platform = this.dataset.platform;
            const url = encodeURIComponent(window.location.href);
            const title = encodeURIComponent(document.title);
            
            let shareUrl = '';
            
            switch (platform) {
                case 'twitter':
                    shareUrl = `https://twitter.com/intent/tweet?url=${url}&text=${title}`;
                    break;
                case 'facebook':
                    shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
                    break;
                case 'linkedin':
                    shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${url}`;
                    break;
                case 'reddit':
                    shareUrl = `https://reddit.com/submit?url=${url}&title=${title}`;
                    break;
            }
            
            if (shareUrl) {
                window.open(shareUrl, '_blank', 'width=600,height=400');
            }
        });
    });
    
    // Copy link functionality
    const copyLinkBtn = document.querySelector('.copy-link-btn');
    if (copyLinkBtn) {
        copyLinkBtn.addEventListener('click', function() {
            navigator.clipboard.writeText(window.location.href).then(function() {
                this.textContent = 'Copied!';
                setTimeout(() => {
                    this.textContent = 'Copy Link';
                }, 2000);
            }.bind(this));
        });
    }
}

// Post navigation functionality
function initPostNavigation() {
    const prevBtn = document.querySelector('.post-nav .prev');
    const nextBtn = document.querySelector('.post-nav .next');
    
    // Keyboard navigation
    document.addEventListener('keydown', function(e) {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
        
        if (e.key === 'ArrowLeft' && prevBtn) {
            window.location.href = prevBtn.href;
        } else if (e.key === 'ArrowRight' && nextBtn) {
            window.location.href = nextBtn.href;
        }
    });
}

// Reading time calculation
function initReadingTime() {
    const content = document.querySelector('.post-content');
    const readingTimeElement = document.querySelector('.reading-time');
    
    if (!content || !readingTimeElement) return;
    
    const text = content.textContent || content.innerText || '';
    const wordCount = text.trim().split(/\s+/).length;
    const readingTime = Math.ceil(wordCount / 200); // 200 words per minute
    
    readingTimeElement.textContent = `${readingTime} min read`;
}

// Scroll progress indicator
function initScrollProgress() {
    const progressBar = document.querySelector('.scroll-progress');
    if (!progressBar) {
        // Create progress bar if it doesn't exist
        const bar = document.createElement('div');
        bar.className = 'scroll-progress';
        bar.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 0%;
            height: 3px;
            background: #007bff;
            z-index: 1000;
            transition: width 0.1s ease;
        `;
        document.body.appendChild(bar);
    }
    
    function updateScrollProgress() {
        const scrollTop = window.pageYOffset;
        const docHeight = document.documentElement.scrollHeight - window.innerHeight;
        const scrollPercent = (scrollTop / docHeight) * 100;
        
        const progressBar = document.querySelector('.scroll-progress');
        if (progressBar) {
            progressBar.style.width = scrollPercent + '%';
        }
    }
    
    window.addEventListener('scroll', updateScrollProgress);
}

// Related posts functionality
function initRelatedPosts() {
    const relatedPosts = document.querySelectorAll('.related-post');
    
    relatedPosts.forEach(function(post) {
        post.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
            this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
        });
        
        post.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = 'none';
        });
    });
}

// Initialize related posts if they exist
document.addEventListener('DOMContentLoaded', function() {
    initRelatedPosts();
});

// Export for global access
window.ChirpyPost = {
    initPostPage: initPostPage,
    initTOC: initTOC,
    initImagePopup: initImagePopup,
    initCodeCopy: initCodeCopy,
    initShareButtons: initShareButtons
};